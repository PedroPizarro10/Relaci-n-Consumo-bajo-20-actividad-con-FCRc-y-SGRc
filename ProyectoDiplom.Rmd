---
title: "Consumo de alimento en salmones bajo 20% de actividad y su relación con FCRc y SGRc"
author: "Pedro Pizarro"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(datasets)
library(ggplot2)
library(readxl)
library(tidyr)
library(dplyr)
library(lme4)
library(graphics)
library(stats)
library(stringr)
library(gridExtra)
library(knitr)
```

### Base de datos

Los datos a utilizar corresponden a una base de datos con 7 variables: Año de cultivo **(Year_class)**, unidad de cultivo **(Jaula)** ,fecha en que se cosechó la jaula **(Fecha_cosecha)**, el alimento consumido bajo 20% de actividad **(Consumo_bajo_20)**, factor de conversión corregido **(FCRc)** y tasa de crecimiento específica corregida **(SGRc)**. Los datos están balanceados.

```{r}
read_excel("Base_Datos_Cons_FCR_SGR.xlsx")
BDatos <-read_excel("Base_Datos_Cons_FCR_SGR.xlsx")
```

```{r}
summary(BDatos)
```
En el resumen, las características de los datos de las variables recomiendan la transformación a factor de algunas de ellas.

```{r}
BDatos$Year_class <- as.factor(BDatos$Year_class)
BDatos$`Fecha_cosecha` <- as.factor(BDatos$`Fecha_cosecha`)
BDatos$Jaula <-as.factor(BDatos$Jaula)
BDatos$Centro <- as.factor (BDatos$Centro)
summary(BDatos)
str(BDatos)
```

Las variables de mayor interés en este caso son **Consumo_bajo_20**, **FCRc** y **SGRc** que son variables cuantitativas continuas, mostrando al aplicar la función de densidad empírica y la función de distribución empírica acumulada la forma de la curva característica de este tipo de variables.

```{r}
par(mfrow=c(2,3))
plot (density(BDatos$`Consumo_ bajo_ 20`))
plot (density(BDatos$FCRc))
plot (density(BDatos$SGRc))
plot (ecdf(BDatos$`Consumo_ bajo_ 20`))
plot (ecdf(BDatos$FCRc))
plot (ecdf(BDatos$SGRc))
```

En la base de datos importada, los valores de las variables de estudio estaban en formato "número" y para una mejor comprensión estas variables deben expresarse en porcentajes. Por lo tanto, se realiza la transformación de estas a % y se seleccionan las variables de mayor interés para el estudio preliminar.


```{r, BDatos_mod}
BDatos_mod <-BDatos %>% mutate(Consumo_20=`Consumo_ bajo_ 20` *100 , FCRc_porc=FCRc*100, SGRc_porc=SGRc*100) %>% select (Year_class, Centro, Consumo_20, FCRc_porc,SGRc_porc)
summary (BDatos_mod)
str(BDatos_mod)
```

```{r}
Mi_gráfico = theme(axis.title.x = element_text(size = 12), axis.text.x = element_text(size = 12), axis.title.y = element_text(size = 12), axis.text.y = element_text(size = 12))
Mi_gráfico_2 = theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(angle =45 , vjust= 1,0 , hjust= 1,0, size = 12), axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12))

```

Los histogramas construidos para las tres variables demuestran que habrían valores atípicos de manera más marcada en los datos de las variables  de consumo bajo 20% de actividad y SGRc.

```{r}
Hist_Cons <- ggplot(BDatos_mod, aes(Consumo_20))+theme_gray()+
  geom_histogram(bins = 10, color= "black",fill="light blue")+
  labs(title="Hist. Consumo bajo 20% act.", x="Consumo bajo 20% actividad", y="Frecuencia")+ Mi_gráfico
```

```{r}
Hist_FCRc <- ggplot(BDatos_mod, aes(FCRc_porc))+theme_gray()+
  geom_histogram(bins = 10, color= "black",fill="light green")+
  labs(title="Histograma FCRc", x="FCRc (conversión)",y="Frecuencia")+ Mi_gráfico
```


```{r}
Hist_SGRc <- ggplot(BDatos_mod, aes(SGRc_porc))+theme_gray()+
  geom_histogram(bins = 10, color= "black",fill="light yellow")+
  labs(title="Histograma SGRc", x="SGRc (crecimiento)", 
       y="Frecuencia")+ Mi_gráfico
```

```{r}
grid.arrange (Hist_Cons, Hist_FCRc, Hist_SGRc, ncol=2, nrow =2)
```

Los gráficos de caja a partir de Centro de cultivo para las variables FCRc y SGRc indican diversa variabilidad de los datos entre centros y valores atípicos que deben investigarse para su probable eliminación. Para una mejor visualización de los gráficos, lo nombres de los centros se reemplazan en algunos casos y en otros, se utiliza como nuevo identificador las tres primeras letras del nombre.

```{r}
BDatos_mod_2 <- BDatos_mod
BDatos_mod_2$Centro <- str_replace_all (BDatos_mod$Centro, c("Elena Norte" = "ElN", "Elena Weste"="ElW", "Punta Cola"= "PCo", "Punta Rouse"= "PRo", "Isla Level 2" = "Level"))
BDatos_mod_2 <- BDatos_mod_2 %>% mutate (ID_Centro= substr(Centro,1,3))
```


```{r}
ggplot(BDatos_mod_2 , aes(x=reorder(ID_Centro , FCRc_porc) , y=FCRc_porc , fill= ID_Centro)) + geom_boxplot(color= "brown") + labs( x="Centro de cultivo", y="FCRc") + Mi_gráfico_2
```


```{r}
ggplot(BDatos_mod_2 , aes(x= reorder(ID_Centro ,SGRc_porc), y=SGRc_porc ,fill=ID_Centro)) +
    geom_boxplot(color= "brown") + labs( x="Centro de cultivo" , y="SGRc")+ Mi_gráfico_2
```

```{r}
ggplot(BDatos_mod_2 , aes(x= reorder(ID_Centro , Consumo_20), y= Consumo_20 ,fill=ID_Centro)) +
    geom_boxplot(color= "brown") + labs( x="Centro de cultivo" , y="Consumo bajo 20% actividad")+ Mi_gráfico_2
```

En los gráficos de dispersión a partir de Consumo de alimento bajo 20% para FCRc y SFRc se puede observar la correlación entre las variables, con tendencia a aumentar el FCRc y disminuir el SGRc a medida que aumenta el consumo de alimento bajo 20% de actividad.

```{r}
ggplot(BDatos_mod , aes(x= Consumo_20 , y=FCRc_porc)) +
    geom_point(color= "blue") + labs( x="Consumo bajo 20% actividad" , y="FCRc")+ Mi_gráfico
```

```{r}
ggplot(BDatos_mod , aes(x= Consumo_20 , y=SGRc_porc)) +
    geom_point (color= "brown") + labs( x="Consumo bajo 20% actividad" , y="SGRc")+ Mi_gráfico
```

Se construye una nueva tabla agrupando por Centro y considerando el promedio de cada variable de estudio.

```{r}
BDatos_mod %>% group_by(Centro) %>% summarise(Consumo20_prom = mean(Consumo_20), FCRc_prom = mean(FCRc_porc), SGRc_prom =mean(SGRc_porc))   
BDatos_gcentro <- BDatos_mod %>% group_by(Centro) %>% summarise(Consumo20_prom = mean(Consumo_20), FCRc_prom = mean(FCRc_porc), SGRc_prom =mean(SGRc_porc))   

```

De la tabla anterior de filtran los % de consumo bajo el 20% de actividad mayores a 12%

```{r}
BDatos_gcentro %>% filter(Consumo20_prom > 12)%>%arrange(-Consumo20_prom)
BDatos_top <- BDatos_gcentro %>% filter(Consumo20_prom > 12)%>%arrange (-Consumo20_prom)

```


En el gráfico, la línea de tendencia indica que a mayor consumo de alimento bajo el 20% de actividad el FCRc aumentaría (considerando todos los datos).

```{r}
 ggplot(BDatos_mod , aes(x= Consumo_20 , y=FCRc_porc))+ geom_smooth(method = "lm",  se= TRUE , color= "blue") + Mi_gráfico
```


En el gráfico, la línea de tendencia indica que a mayor consumo de alimento bajo el 20% de actividad el SGRc disminuiría (considerando todos los datos).

```{r}
 ggplot(BDatos_mod , aes(x= Consumo_20 , y=SGRc_porc))+ geom_smooth(method = "lm", se= TRUE, color= "red")  + Mi_gráfico
```

Existe correlación entre las variables, sin embargo el coeficiente de correlación en ambos casos es débil

```{r}
cor(BDatos_mod$Consumo_20 , BDatos_mod$FCRc_porc)
cor(BDatos_mod$Consumo_20 , BDatos_mod$SGRc_porc)
```
Cuando se considera la selección de los centros con los consumos más altos bajo 20% de de actividad y su relación con las variables FCRc y SGRc la correlación aumenta de manera considerable en ambos casos.
La correlación entre consumo bajo 20% y FCRc es positiva, es decir, el aumento de una variable significa un aumento de la otra, a diferencia de la correlación negativa que demuestra la variable SGRC.

```{r}
head(BDatos_top)
```
```{r}
cor(BDatos_top$Consumo20_prom , BDatos_top$FCRc_prom)
cor(BDatos_top$Consumo20_prom , BDatos_top$SGRc_prom)
```






